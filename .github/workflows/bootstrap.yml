name: Bootstrap Terraform State

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'create'
        type: choice
        options:
          - create
          - destroy

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  PROJECT_NAME: ${{ vars.PROJECT_NAME || 'error-debugger' }}

jobs:
  bootstrap:
    name: Bootstrap Terraform State Backend
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'create'
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create S3 Bucket for Terraform State
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="${PROJECT_NAME}-terraform-state-${ACCOUNT_ID}"
          
          echo "ğŸª£ Creating S3 bucket: $BUCKET_NAME"
          
          # Create bucket (us-east-1 doesn't need LocationConstraint)
          if [ "$AWS_REGION" = "us-east-1" ]; then
            aws s3api create-bucket --bucket "$BUCKET_NAME" --region $AWS_REGION
          else
            aws s3api create-bucket --bucket "$BUCKET_NAME" --region $AWS_REGION \
              --create-bucket-configuration LocationConstraint=$AWS_REGION
          fi
          
          # Enable versioning
          echo "ğŸ“¦ Enabling versioning..."
          aws s3api put-bucket-versioning \
            --bucket "$BUCKET_NAME" \
            --versioning-configuration Status=Enabled
          
          # Enable encryption
          echo "ğŸ” Enabling encryption..."
          aws s3api put-bucket-encryption \
            --bucket "$BUCKET_NAME" \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                },
                "BucketKeyEnabled": true
              }]
            }'
          
          # Block public access
          echo "ğŸš« Blocking public access..."
          aws s3api put-public-access-block \
            --bucket "$BUCKET_NAME" \
            --public-access-block-configuration '{
              "BlockPublicAcls": true,
              "IgnorePublicAcls": true,
              "BlockPublicPolicy": true,
              "RestrictPublicBuckets": true
            }'
          
          echo "âœ… S3 bucket created: $BUCKET_NAME"
      
      - name: Create DynamoDB Table for State Locking
        run: |
          TABLE_NAME="${PROJECT_NAME}-terraform-locks"
          
          echo "ğŸ”’ Creating DynamoDB table: $TABLE_NAME"
          
          aws dynamodb create-table \
            --table-name "$TABLE_NAME" \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --tags Key=Project,Value=$PROJECT_NAME Key=ManagedBy,Value=github-actions
          
          echo "â³ Waiting for table to be active..."
          aws dynamodb wait table-exists --table-name "$TABLE_NAME"
          
          echo "âœ… DynamoDB table created: $TABLE_NAME"
      
      - name: Create ECR Repository
        run: |
          REPO_NAME="${PROJECT_NAME}-prod-agent"
          
          echo "ğŸ³ Creating ECR repository: $REPO_NAME"
          
          aws ecr create-repository \
            --repository-name "$REPO_NAME" \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256 \
            --tags Key=Project,Value=$PROJECT_NAME Key=ManagedBy,Value=github-actions \
            || echo "Repository may already exist"
          
          echo "âœ… ECR repository ready: $REPO_NAME"
      
      - name: Summary
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          
          echo "## ğŸš€ Bootstrap Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Created" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Bucket | \`${PROJECT_NAME}-terraform-state-${ACCOUNT_ID}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| DynamoDB Table | \`${PROJECT_NAME}-terraform-locks\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ECR Repository | \`${PROJECT_NAME}-prod-agent\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run the **Deploy** workflow to create AgentCore infrastructure" >> $GITHUB_STEP_SUMMARY

  destroy-bootstrap:
    name: Destroy Bootstrap Resources
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy'
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Destroy Bootstrap Resources
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="${PROJECT_NAME}-terraform-state-${ACCOUNT_ID}"
          TABLE_NAME="${PROJECT_NAME}-terraform-locks"
          REPO_NAME="${PROJECT_NAME}-prod-agent"
          
          echo "âš ï¸ Destroying bootstrap resources..."
          
          # Empty and delete S3 bucket
          echo "ğŸ—‘ï¸ Emptying S3 bucket..."
          aws s3 rm s3://$BUCKET_NAME --recursive || true
          
          # Delete all versions (for versioned bucket)
          echo "ğŸ—‘ï¸ Deleting all versions..."
          aws s3api list-object-versions --bucket $BUCKET_NAME --query 'Versions[].{Key:Key,VersionId:VersionId}' --output json 2>/dev/null | \
            jq -r '.[] | "\(.Key) \(.VersionId)"' | \
            while read key version; do
              aws s3api delete-object --bucket $BUCKET_NAME --key "$key" --version-id "$version" || true
            done
          
          # Delete markers
          aws s3api list-object-versions --bucket $BUCKET_NAME --query 'DeleteMarkers[].{Key:Key,VersionId:VersionId}' --output json 2>/dev/null | \
            jq -r '.[] | "\(.Key) \(.VersionId)"' | \
            while read key version; do
              aws s3api delete-object --bucket $BUCKET_NAME --key "$key" --version-id "$version" || true
            done
          
          echo "ğŸ—‘ï¸ Deleting S3 bucket..."
          aws s3api delete-bucket --bucket $BUCKET_NAME || true
          
          # Delete DynamoDB table
          echo "ğŸ—‘ï¸ Deleting DynamoDB table..."
          aws dynamodb delete-table --table-name $TABLE_NAME || true
          
          # Delete ECR repository
          echo "ğŸ—‘ï¸ Deleting ECR repository..."
          aws ecr delete-repository --repository-name $REPO_NAME --force || true
          
          echo "âœ… Bootstrap resources destroyed"

