name: Deploy Error Debugger

on:
  push:
    branches: [main]
    paths:
      - 'agent/**'
      - 'app/**'
      - 'terraform/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  PROJECT_NAME: ${{ vars.PROJECT_NAME || 'error-debugger' }}
  ENVIRONMENT: ${{ vars.ENVIRONMENT || 'prod' }}
  TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'error-debugger' }}
  TF_VAR_environment: ${{ vars.ENVIRONMENT || 'prod' }}
  TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'destroy'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false
      
      # ===== Get Backend Bucket Name =====
      - name: Get Terraform Backend
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="${PROJECT_NAME}-terraform-state-${ACCOUNT_ID}"
          echo "TF_BACKEND_BUCKET=${BUCKET_NAME}" >> $GITHUB_ENV
          echo "Using backend bucket: $BUCKET_NAME"
      
      # ===== Build & Push Container =====
      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Set up QEMU (for ARM64)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Build & Push Agent Container
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REPO_URL="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${PROJECT_NAME}-${ENVIRONMENT}-agent"
          
          echo "ðŸ³ Building multi-agent container for ARM64..."
          cd agent
          docker buildx build \
            --platform linux/arm64 \
            --push \
            -t ${REPO_URL}:latest \
            -t ${REPO_URL}:${{ github.sha }} \
            .
          
          echo "CONTAINER_IMAGE=${REPO_URL}:latest" >> $GITHUB_ENV
      
      # ===== Terraform =====
      - name: Terraform Init
        working-directory: terraform/agentcore
        run: terraform init -upgrade -backend-config="bucket=${{ env.TF_BACKEND_BUCKET }}"
      
      - name: Terraform Plan
        working-directory: terraform/agentcore
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        working-directory: terraform/agentcore
        run: terraform apply -auto-approve tfplan
      
      # ===== Get Outputs =====
      - name: Get Terraform Outputs
        id: tf-outputs
        working-directory: terraform/agentcore
        run: |
          echo "ecr_repository=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT
          echo "s3_bucket=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT
          echo "runtime_id=$(terraform output -raw runtime_id)" >> $GITHUB_OUTPUT
          echo "gateway_url=$(terraform output -raw gateway_endpoint)" >> $GITHUB_OUTPUT
          echo "memory_id=$(terraform output -raw memory_id)" >> $GITHUB_OUTPUT
          echo "website_url=$(terraform output -raw website_url)" >> $GITHUB_OUTPUT
      
      # ===== Deploy Frontend =====
      - name: Deploy Frontend
        run: |
          # Create runtime config
          cat > app/config.js << EOF
          window.AGENTCORE_CONFIG = {
            gatewayUrl: '${{ steps.tf-outputs.outputs.gateway_url }}',
            runtimeId: '${{ steps.tf-outputs.outputs.runtime_id }}',
            memoryId: '${{ steps.tf-outputs.outputs.memory_id }}',
            demoMode: false,
          };
          EOF
          
          # Sync static assets with long cache
          aws s3 sync app/ s3://${{ steps.tf-outputs.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "config.js"
          
          # Upload HTML and config with no-cache
          aws s3 cp app/index.html s3://${{ steps.tf-outputs.outputs.s3_bucket }}/ \
            --cache-control "no-cache, no-store, must-revalidate"
          
          aws s3 cp app/config.js s3://${{ steps.tf-outputs.outputs.s3_bucket }}/ \
            --cache-control "no-cache, no-store, must-revalidate"
      
      # ===== Invalidate CloudFront =====
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.tf-outputs.outputs.cloudfront_id }} \
            --paths "/*"
      
      # ===== Summary =====
      - name: Deployment Summary
        run: |
          echo "## ðŸ› Error Debugger Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AgentCore Resources" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime | \`${{ steps.tf-outputs.outputs.runtime_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway | \`${{ steps.tf-outputs.outputs.gateway_url }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Memory | \`${{ steps.tf-outputs.outputs.memory_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Website" >> $GITHUB_STEP_SUMMARY
          echo "[${{ steps.tf-outputs.outputs.website_url }}](${{ steps.tf-outputs.outputs.website_url }})" >> $GITHUB_STEP_SUMMARY

  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy'
    environment: destroy
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
      
      - name: Get Terraform Backend
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="${PROJECT_NAME}-terraform-state-${ACCOUNT_ID}"
          echo "TF_BACKEND_BUCKET=${BUCKET_NAME}" >> $GITHUB_ENV
      
      - name: Terraform Init
        working-directory: terraform/agentcore
        run: terraform init -backend-config="bucket=${{ env.TF_BACKEND_BUCKET }}"
      
      - name: Empty S3 Bucket
        run: |
          cd terraform/agentcore
          BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
          if [ -n "$BUCKET" ]; then
            echo "Emptying bucket: $BUCKET"
            aws s3 rm s3://$BUCKET --recursive || true
          fi
      
      - name: Terraform Destroy
        working-directory: terraform/agentcore
        run: terraform destroy -auto-approve
      
      - name: Summary
        run: |
          echo "## ðŸ—‘ï¸ Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All AgentCore resources have been removed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Bootstrap resources (S3 state bucket, DynamoDB lock table, ECR) are preserved." >> $GITHUB_STEP_SUMMARY
          echo "Run the **Bootstrap** workflow with 'destroy' to remove those as well." >> $GITHUB_STEP_SUMMARY

